<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fibikky.vehicle.web.main.mappers.ExceptionMapper">

    <select id="listByPage" resultType="com.fibikky.vehicle.web.main.dto.ExceptionList">
        select *
        from
        exception
        left join detection_station ds on exception.exception_detection_station=ds.detection_station_id
        left join detection_line dl on exception.exception_detection_line=dl.detection_line_id
        left join monitor on exception.exception_detection_monitor=monitor.monitor_id
        <where>
            <if test="query.exceptionId!=null and query.exceptionId!=''">

                and exception.exception_id= #{query.exceptionId}

            </if>
            <if test="query.isHandled!=null and query.isHandled!=''">
                and exception.exception_status= #{query.isHandled}
            </if>
            <if test="query.exceptionType!=null and query.exceptionType!=''">
                and (exception.exception_type like concat('%', #{query.exceptionType}, '%'))
            </if>
            <if test="query.abnormalVehicleNumber!=null and query.abnormalVehicleNumber!=''">
                and (exception.abnormal_vehicle_number like concat('%', #{query.abnormalVehicleNumber}, '%'))
            </if>
            <if test="query.exceptionStartTime!=null and query.exceptionStartTime!=''">
                <![CDATA[  and exception.exception_time >= #{query.exceptionStartTime}  ]]>
            </if>
            <if test="query.exceptionEndTime!=null and query.exceptionEndTime!=''">
                <![CDATA[  and exception.exception_time <= #{query.exceptionEndTime}  ]]>
            </if>
            <if test="query.monitorName!=null and query.monitorName!=''">
                and (monitor.monitor_name like concat('%', #{query.monitorName}, '%'))
            </if>
            <if test="query.detectionLineName!=null and query.detectionLineName!=''">
                and (dl.detection_line_name like concat('%', #{query.detectionLineName}, '%'))

            </if>
            <if test="query.detectionStationName!=null and query.detectionStationName!=''">
                and (ds.detection_station_name like concat('%', #{query.detectionStationName}, '%'))
            </if>
        </where>
    </select>
    <select id="export" resultType="com.fibikky.vehicle.web.main.entities.Exception">
        select *
        from
        exception
        left join detection_station ds on exception.exception_detection_station=ds.detection_station_id
        left join detection_line dl on exception.exception_detection_line=dl.detection_line_id
        left join monitor on exception.exception_detection_monitor=monitor.monitor_id
        <where>
            <if test="query.isHandled!=null and query.isHandled!=''">
                and exception.exception_status= #{query.isHandled}
            </if>
            <if test="query.exceptionType!=null and query.exceptionType!=''">
                and (exception.exception_type like concat('%', #{query.exceptionType}, '%'))
            </if>
            <if test="query.abnormalVehicleNumber!=null and query.abnormalVehicleNumber!=''">
                and (exception.abnormal_vehicle_number like concat('%',#{query.abnormalVehicleNumber}, '%'))
            </if>
            <if test="query.exceptionStartTime!=null and query.exceptionStartTime!=''">

                <![CDATA[  and exception.exception_time >= #{query.exceptionStartTime}  ]]>
            </if>
            <if test="query.exceptionEndTime!=null and query.exceptionEndTime!=''">

                <![CDATA[  and exception.exception_time <= #{query.exceptionEndTime}  ]]>

            </if>
            <if test="query.monitorName!=null and query.monitorName!=''">
                and monitor.monitor_name like concat('%', #{query.monitorName}, '%')
            </if>
            <if test="query.detectionLineName!=null and query.detectionLineName!=''">
                and dl.detection_line_name like concat('%', #{query.detectionLineName}, '%')
            </if>
            <if test="query.detectionStationName!=null and query.detectionStationName!=''">
                and ds.detection_station_name like concat('%', #{query.detectionStationName}, '%')

            </if>
        </where>
    </select>
    <select id="getExceptionCountIntervalScopeDay" resultType="com.fibikky.vehicle.web.main.dto.WeekException">
        select exception_time ,count(*) as exceptionCount
        from
        exception
        <where>
            <if test="query.detectionLineId!=null and query.detectionLineId!=''">
                and exception.exception_detection_line= #{query.detectionLineId}
            </if>
            <if test="query.isHandled!=null and query.isHandled!=''">
                and exception.exception_status= #{query.isHandled}
            </if>
            and exception_time between CURDATE()-#{query.scope} and CURDATE() group by exception_time
        </where>
    </select>
</mapper>